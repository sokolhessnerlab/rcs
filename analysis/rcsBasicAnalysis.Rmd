---
title: "RCS Basic Analysis"
author: "Hayley Brooks"
date: "2022-10-12"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())

library('config')
config = config::get()


setup_source = file.path(config$path$code_files$dataSetUp) # run our set up script (which loads all the data)
source(setup_source) #, local = knitr::knit_global())
```

#### How many participants are in each condition/order?
```{r conditions, echo=FALSE}

cat("participants in natural-natural condition:",sum(rcsSubLevelWide_clean$condCode==1), "\nparticipants in natural-strategy condition:",sum(rcsSubLevelWide_clean$condCode==2), "\nparticipants in strategy-natural condition:",sum(rcsSubLevelWide_clean$condCode==3),"\nparticipants in strategy-strategy condition:", sum(rcsSubLevelWide_clean$condCode==4))


condcode1 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==1]
condcode2 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==2]
condcode3 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==3]
condcode4 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==4]
```


#### Average change in risk-taking across conditions
```{r, risk-taking-across-rounds, echo=FALSE}

# differences in pgam from round 1 to round 2:
pgamDiff = rcsSubLevelWide_clean$round1_pgamble - rcsSubLevelWide_clean$round2_pgamble

cat("\nChange in risk-taking from round1 to round 2 \n(round 1-round2)\n",mean(pgamDiff))

# pgamble diff between round 1 and 2 across conditions
# control, control

cat("\nDifference in risk-taking across rounds \nnatural(round1) - natural (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode1)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode1)]))


# control, strategy
cat("\nDifference in risk-taking across rounds \nnatural(round1) - strategy (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode2)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode2)]))

# strategy, control
cat("\nDifference in risk-taking across rounds \nstrategy(round1) - natural (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode3)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode3)]))

# strategy, strategy
cat("\nDifference in risk-taking across rounds \nstrategy(round1) - strategy (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode4)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode4)]))

```

#### Plot change in risk-taking across rounds and conditions
##### More risk taking in strategy condition (regardless of order)
```{r plot-basics, echo=FALSE}

#pdf("/Users/hayley/Desktop/shenhavLabTalk/risk-taking_rounds.pdf")
# plot(RDMqualityCheck$pgambleRound1[-c(12,15)]-RDMqualityCheck$pgambleRound2[-c(12,15)], ylab ="pGamble(round 1 - round 2)", xlab="participant", main="change in risk-taking across rounds", axes=F, pch=16, col="maroon", cex=1.5, ylim=c(-.4,.4), xlim=c(1,24))
# abline(h=0, col="grey", lty="dashed")
# axis(1, at = 1:nSub, labels = 1:nSub, lwd=3)
# axis(2, at = seq(-.4, .4, .1), lwd=3)
#dev.off()


# create a variable for condition code
# 1 = control, control
# 2 = control, strategy
# 3 = strategy, control
# 4 = strategy, strategy

#pdf("/Users/hayley/Desktop/shenhavLabTalk/rpgamByRoundAllcond.pdf")
par(pty="s")
plot(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==1], rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==1], asp=1,col="blue", pch=16, ylim=c(0,1), xlim=c(0,1), ylab="p(gamble round 1)", xlab="p(gamble round 2)", axes=F, cex=2)

abline(a = 0, b=1, lty="dashed", col="darkgrey",lwd=5)

points(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==2], rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==2], col="green",asp=1, pch=16,cex=2)

points(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==3], rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==3], asp=1, col="red", pch=16, cex=2)


points(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==4], rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==4], asp= 1,col="purple", pch=16, cex=2)
axis(1, lwd=6)
axis(2, lwd=6)
legend("bottomright", legend=c("nat-nat","nat-strat", "strat-nat" ,"strat-strat"), pch=16, bty="n", col=c("blue", "green", "red", "purple"), cex=1)

#dev.off()


#pdf("/Users/hayley/Desktop/shenhavLabTalk/rpgamDiff_cond2_cond3.pdf")
plot(c(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==2]- rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==2], rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$condCode==3]- rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$condCode==3]), pch=16, ylab="Risk-taking\n (round 1 - round 2)", xlab="participant", ylim=c(-.5,.5),cex= 2,col=c(rep("green",length(condcode2)), rep("red", length(condcode3))), axes=F)
axis(1, at =1:sum(rcsSubLevelWide_clean$condCode %in% c(2,3)), labels = as.numeric(c(rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==2], rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==3])), lwd=6, cex.axis=1)
axis(2, lwd=6, cex=1.5)
abline(h=0, col="darkgrey", lty="dashed", lwd=4)

legend("bottomright", legend=c("nat-strat", "strat-nat"), pch=16, bty="n", col=c("green","red"), cex=1)
#dev.off()



```


#### Post round difficulty ratings
```{r instDifficulty-ratings}
# summary stats for diffciculty ratings in each condition and order
# participant generally felt that strategy was more difficult, on average.
summary(rcsSubLevelLong_clean$instDifficult[rcsSubLevelLong_clean$strategy==0])
summary(rcsSubLevelLong_clean$instDifficult[rcsSubLevelLong_clean$strategy==1])

# for participants who did natural condition both rounds, difficulty ratings is on average, higher for second round
natNatRound1difficulty = rcsSubLevelWide_clean$round1_instDifficult[rcsSubLevelWide_clean$condCode==1]
natNatRound2difficulty = rcsSubLevelWide_clean$round2_instDifficult[rcsSubLevelWide_clean$condCode==1]

summary(natNatRound1difficulty)
summary(natNatRound2difficulty)


# for participants who did natural then strategy, difficulty rating is on average, higher for second round (strategy harder)
natStratRound1difficulty = rcsSubLevelWide_clean$round1_instDifficult[rcsSubLevelWide_clean$condCode==2]
natStratRound2difficulty = rcsSubLevelWide_clean$round2_instDifficult[rcsSubLevelWide_clean$condCode==2]

summary(natStratRound1difficulty)
summary(natStratRound2difficulty)

# for participants who did strategy then natural, difficulty rating is on average, higher for first round (strategy harder)
stratNatRound1difficulty = rcsSubLevelWide_clean$round1_instDifficult[rcsSubLevelWide_clean$condCode==3]
stratNatRound2difficulty = rcsSubLevelWide_clean$round2_instDifficult[rcsSubLevelWide_clean$condCode==3]

summary(stratNatRound1difficulty)
summary(stratNatRound2difficulty)

# for participants who did strategy then strategy, difficulty rating is on average, higher for first round 
stratStratRound1difficulty = rcsSubLevelWide_clean$round1_instDifficult[rcsSubLevelWide_clean$condCode==4]
stratStratRound2difficulty = rcsSubLevelWide_clean$round2_instDifficult[rcsSubLevelWide_clean$condCode==4]

summary(stratStratRound1difficulty)
summary(stratStratRound2difficulty)

# these results suggest that we could use the round 1 ratings for natural vs strategy to compare 

pdf(file.path(config$path$directory, config$path$shlab_figures,'InstDifficultyRatingPlots.pdf'))
par(pty="s", mfrow= c(2,2))
plot(natNatRound1difficulty, natNatRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Act natural Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="blue")
abline(a=0, b=1, col="grey")

plot(natStratRound1difficulty, natStratRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="green")
abline(a=0, b=1, col="grey")

plot(stratNatRound1difficulty, stratNatRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Act Natural Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="red")
abline(a=0, b=1, col="grey")

plot(stratStratRound1difficulty, stratStratRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="purple")
abline(a=0, b=1, col="grey")

mtext("Instruction Difficulty Ratings", side = 3, line = - 2, outer = TRUE)
dev.off()

```


#### Post round how often ratings
```{r instFrequency-ratings}
# summary stats for how often ratings in each condition and order

# participants rated, on average, that they were able to follow instructions about 74% of the time with a slightly higher rating reported for the strategy condition
summary(rcsSubLevelLong_clean$instHowOften[rcsSubLevelLong_clean$strategy==0])
summary(rcsSubLevelLong_clean$instHowOften[rcsSubLevelLong_clean$strategy==1])


# for participants who did natural condition both rounds, participants felt they followed task instructions roughly the same amount of time across rounds
natNatRound1howOften = rcsSubLevelWide_clean$round1_instHowOften[rcsSubLevelWide_clean$condCode==1]
natNatRound2howOften = rcsSubLevelWide_clean$round2_instHowOften[rcsSubLevelWide_clean$condCode==1]

summary(natNatRound1howOften)
summary(natNatRound2howOften)


# for participants who did natural then strategy, participants report implementing strategy condition less often than acting natural (rather large difference)
natStratRound1howOften = rcsSubLevelWide_clean$round1_instHowOften[rcsSubLevelWide_clean$condCode==2]
natStratRound2howOften = rcsSubLevelWide_clean$round2_instHowOften[rcsSubLevelWide_clean$condCode==2]

summary(natStratRound1howOften)
summary(natStratRound2howOften)

# for participants who did strategy then natural, participants report implementing act natural instructions slightly more often than strategy (smaller difference than above)
# harder to act natural after doing strategy (even though strategy was implemented less of the time)
stratNatRound1howOften = rcsSubLevelWide_clean$round1_instHowOften[rcsSubLevelWide_clean$condCode==3]
stratNatRound2howOften = rcsSubLevelWide_clean$round2_instHowOften[rcsSubLevelWide_clean$condCode==3]

summary(stratNatRound1howOften)
summary(stratNatRound2howOften)

# for participants who did strategy then strategy, participants rated following instructions more, on average, in the first round, relative to second round.
stratStratRound1howOften = rcsSubLevelWide_clean$round1_instHowOften[rcsSubLevelWide_clean$condCode==4]
stratStratRound2howOften = rcsSubLevelWide_clean$round2_instHowOften[rcsSubLevelWide_clean$condCode==4]

summary(stratStratRound1howOften)
summary(stratStratRound2howOften)

# although people feel like natural and strategy are different in difficulty, it looks like they are able to do implement them roughly the same amount of time (here we are seeing averages for all 70-80%)

pdf(file.path(config$path$directory, config$path$shlab_figures,'InstFrequencyRatingPlots.pdf'))
par(pty="s", mfrow= c(2,2))
plot(natNatRound1howOften, natNatRound2howOften, ylim=c(0,100), xlim=c(0,100), ylab="Act natural Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="blue")
abline(a=0, b=1, col="grey")

plot(natStratRound1howOften, natStratRound2howOften, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="green")
abline(a=0, b=1, col="grey")

plot(stratNatRound1howOften, stratNatRound2howOften, ylim=c(0,100), xlim=c(0,100), ylab="Act Natural Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="red")
abline(a=0, b=1, col="grey")

plot(stratStratRound1howOften, stratStratRound2howOften, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="purple")
abline(a=0, b=1, col="grey")

mtext("Instruction Frequency Ratings", side = 3, line = - 2, outer = TRUE)
dev.off()

```

#### average RT across conditions

```{r RT-conditions}

# On average, participants are slower to respond in the strategy condition
summary(rcsSubLevelLong_clean$RT[rcsSubLevelLong_clean$strategy==0])
summary(rcsSubLevelLong_clean$RT[rcsSubLevelLong_clean$strategy==1])


# for participants who did natural then natural, they are, on average, faster in the second round
natNatRound1rt = rcsSubLevelWide_clean$round1_RT[rcsSubLevelWide_clean$condCode==1]
natNatRound2rt = rcsSubLevelWide_clean$round2_RT[rcsSubLevelWide_clean$condCode==1]

summary(natNatRound1rt)
summary(natNatRound2rt)

# for participants who did natural then strategy, they are slightly slower in the first round (natural)
natStratRound1rt = rcsSubLevelWide_clean$round1_RT[rcsSubLevelWide_clean$condCode==2]
natStratRound2rt = rcsSubLevelWide_clean$round2_RT[rcsSubLevelWide_clean$condCode==2]

summary(natStratRound1rt)
summary(natStratRound2rt)


# for participants who did strategy then natural, they are slightly slower in the first round (strategy) relative to second (natural) but the difference is very  small
stratNatRound1rt = rcsSubLevelWide_clean$round1_RT[rcsSubLevelWide_clean$condCode==3]
stratNatRound2rt = rcsSubLevelWide_clean$round2_RT[rcsSubLevelWide_clean$condCode==3]

summary(stratNatRound1rt)
summary(stratNatRound2rt)


# for participants who did strategy then strategy, they are faster in the second round
stratStratRound1rt = rcsSubLevelWide_clean$round1_RT[rcsSubLevelWide_clean$condCode==4]
stratStratRound2rt = rcsSubLevelWide_clean$round2_RT[rcsSubLevelWide_clean$condCode==4]

summary(stratStratRound1rt)
summary(stratStratRound2rt)

# when repeating instructions, participants are faster in second round. When switching, the difference is very small.

```

Establishing that conditions are similar: people take similar lengths of time and the frequency is different but not a huge difference even though people do think the strategy is more difficult. 


### Generalized linear mixed effects models
#### Trial-level
##### More risk-taking in strategy condition, but not keeping strategy in trial-level model because we want to use it in recent event models
```{r trial-level-glmer}


model1_trialLev =glmer(choice ~ 1 +  gainScaled + safeScaled + evLevScaled + (1|subID), data=rdmDFclean , family = "binomial")
summary(model1_trialLev)
# AIC = 17298

model2_trialLevRound= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode + (1|subID), data=rdmDFclean , family = "binomial")

summary(model2_trialLevRound)

# gain and safe as expected
# positive effect of round with more risk-taking in round 2
# no effect of ev level 
# AIC = 16574.8 
# including round but not strategy makes the subsequent analyses weird because there is an interaction between round and strategy.

model2_trialLev= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode*strategyRecode + (1|subID), data=rdmDFclean , family = "binomial")

summary(model2_trialLev)

# Gain and safe as expected
# positive main effect of strategy (more risk-taking in strategy condition)
# positive interaction between strategy and round where the weight on the strategy on risk-taking is slightly less in round 1
  # doing the math here to undersand whats happening it seems like the natural condition has a negative effec ton risk-taking but this is weaker in round 1 and the strategy condition has a positive effect on risk-taking but the effect is weaker in round 1.
# AIC = 16540.6
```

```{r save-predicted-values, echo=FALSE}
rdmDFclean$pred= predict(model1_trialLev,type="link"); 
par(mfrow=c(1,1))
#plot(mriBehClean$pred, ylab="predicted values");

```


### Recent event models
####shift effect is not showing up as we'd expect but seeing signs of local and global timescales
####Strategy is interacting with past outcome, earnings and expectations.
#### glmer models are showing up as singular - we will use glm, effects are nearly identical between glmer and glm versions
```{r basic-recent-events-model}

# lets just check round and strategy to see if we get back the things we would have were we to include them in the trial-level mdoel
model_roundStrat = glm(choice ~ 0 + roundRecode*strategyRecode data=rdmDFclean, family="binomial", offset=pred)
# we see similar effects but they are weaker in this model. Which isn't necessarily surprising because of this two step approach and the shared variance being put on the
# trial-level model

#model3_poc = glm(choice ~ 0 + pastOC1sc + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
model3_poc = glm(choice ~ 0 + pastOC1sc, data=rdmDFclean, family="binomial", offset=pred)
summary(model3_poc)
# no outcome effect, negative beta but not significant



model4_pocStrat = glm(choice ~ 0 + pastOC1sc*strategyRecode, data=rdmDFclean, family="binomial", offset=pred)
summary(model4_pocStrat)
#positive interaction between past outcome and strategy but no main effects of outcome or strategy


model5_signedShiftStrat = glm(choice ~ 0 + signedShift*strategyRecode, data=rdmDFclean, family="binomial", offset=pred)
summary(model5_signedShiftStrat)
# positive effect of signed shift on risk-taking (more risk-taking as shift increases, less risk-taking a shift decreases?)
# positive effect of strategy (more risk-taking in strategy condition)
# positive interaction 
    # how does the weight change across conditions and shift sizes:
    # strategy + large positive shift : 20*.01 + 1*.06 + 20*1*.01 = .46
    # strategy + large negative shift : -20*.01 + 1*.06 + -20*1*.01 = -34
    # natural + large positive shift: 20*.01 + -1*.06 + 20*-1*.01 = -.06
    # natural + large negative shift: -20*.01 + -1*.06 + -20*-1*.01 = -.06
    # SHIFT ONLY INFLUENCING IN STRATEGY CONDITION?


model6_posNegShiftStrat = glm(choice ~ 0 + posShift*strategyRecode + negShift*strategyRecode, data=rdmDFclean, family="binomial", offset=pred)
summary(model6_posNegShiftStrat) # 16215
# more risk-taking in strategy condition
# less risk-taking as negative shift increases
# no main effect of positive shift but there is an interaction between positive shift and strategy where strategy makes the positive effect of shift stronger

model7_posNegShift = glm(choice ~ 0 + posShift  + negShift, data=rdmDFclean, family="binomial", offset=pred)
summary(model7_posNegShift) # AIC: 16229
# no effect of positive shift,just negative shift

model8_posShift = glm(choice ~ 0 + posShift, data=rdmDFclean, family="binomial", offset=pred)
summary(model8_posShift) # AIC: 16237
# no effect of positive shift

model8_negShift = glm(choice ~ 0 + negShift, data=rdmDFclean, family="binomial", offset=pred)
summary(model8_negShift)
# AIC: 16228
# slightly better model fit leaving out positive shift

model8_posShift_subsetData = glm(choice ~ 0 + posShift, data=rdmDFclean[rdmDFclean$strategy==0,], family="binomial", offset=pred)
model8_posShift_subsetData = glm(choice ~ 0 + posShift, data=rdmDFclean[rdmDFclean$strategy==0 & rdmDFclean$roundRDM==1,], family="binomial", offset=pred)
summary(model8_posShift_subsetData)
# even subsetting the data in the no strategy condition -- trending negative effect of shift
# when subsetting the data with no strategy and first round - negative effect of positive shift (less risk-taking as positive shift increases)

model8_earnsExp = glm(choice ~ 0 + earnNormalizedOverall + trialSC, data=rdmDFclean, family="binomial", offset=pred)
summary(model8_earnsExp)
# betas are in direction as expected, not significant though


model9_3timescales = glm(choice ~ 0 + pastOC1sc*earnNormalizedOverall + posShift + negShift + trialSC,  data=rdmDFclean, family="binomial", offset=pred)
summary(model9_3timescales)
# negative effect of past outcome, interaction between outcomes and earnings, positive effect of negative shift (more risk-taking a shift is less negative) and significant interaction between past outcome and earnings

#model10_3timescalesStrategy = glmer(choice ~ 0 + pastOC1sc*earnNormalizedOverall*strategyRecode + posShift*strategyRecode + trialSC*strategyRecode + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)


model10_3timescalesStrategy = glm(choice ~ 0 + pastOC1sc*earnNormalizedOverall*strategyRecode + posShift*strategyRecode + negShift*strategyRecode + trialSC*strategyRecode, data=rdmDFclean, family="binomial", offset=pred)

summary(model10_3timescalesStrategy)

# negative effect of past outcome, positive effect of negative shift, interaction between past outcome and earnings, interaction between positive shift and strategy (which would make the positive shift effect stronger)
```



