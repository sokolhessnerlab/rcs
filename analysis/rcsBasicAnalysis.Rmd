---
title: "RCS Basic Analysis"
author: "Hayley Brooks"
date: "2022-10-12"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())

library('config')
config = config::get()


setup_source = file.path(config$path$code_files$dataSetUp) # run our set up script (which loads all the data)
source(setup_source) #, local = knitr::knit_global())
```

#### How many participants are in each condition/order?
```{r conditions, echo=FALSE}

cat("participants in natural-natural condition:",sum(rcsSubLevelWide_clean$condCode==1), "\nparticipants in natural-strategy condition:",sum(rcsSubLevelWide_clean$condCode==2), "\nparticipants in strategy-natural condition:",sum(rcsSubLevelWide_clean$condCode==3),"\nparticipants in strategy-strategy condition:", sum(rcsSubLevelWide_clean$condCode==4))


condcode1 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==1]
condcode2 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==2]
condcode3 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==3]
condcode4 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==4]
```


#### Average change in risk-taking across conditions
```{r, risk-taking-across-rounds, echo=FALSE}

# differences in pgam from round 1 to round 2:
pgamDiff = rcsSubLevelWide_clean$round1_pgamble - rcsSubLevelWide_clean$round2_pgamble

cat("\nChange in risk-taking from round1 to round 2 \n(round 1-round2)\n",mean(pgamDiff))

# pgamble diff between round 1 and 2 across conditions
# control, control

cat("\nDifference in risk-taking across rounds \nnatural(round1) - natural (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode1)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode1)]))


# control, strategy
cat("\nDifference in risk-taking across rounds \nnatural(round1) - strategy (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode2)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode2)]))

# strategy, control
cat("\nDifference in risk-taking across rounds \nstrategy(round1) - natural (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode3)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode3)]))

# strategy, strategy
cat("\nDifference in risk-taking across rounds \nstrategy(round1) - strategy (round2)\ndiff p(gamble)",mean(rcsSubLevelWide_clean$round1_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode4)] - rcsSubLevelWide_clean$round2_pgamble[rcsSubLevelWide_clean$subID %in% as.numeric(condcode4)]))

```

#### Plot change in risk-taking across rounds and conditions
##### More risk taking in strategy condition (regardless of order)
```{r plot-basics, echo=FALSE}

#pdf("/Users/hayley/Desktop/shenhavLabTalk/risk-taking_rounds.pdf")
# plot(RDMqualityCheck$pgambleRound1[-c(12,15)]-RDMqualityCheck$pgambleRound2[-c(12,15)], ylab ="pGamble(round 1 - round 2)", xlab="participant", main="change in risk-taking across rounds", axes=F, pch=16, col="maroon", cex=1.5, ylim=c(-.4,.4), xlim=c(1,24))
# abline(h=0, col="grey", lty="dashed")
# axis(1, at = 1:nSub, labels = 1:nSub, lwd=3)
# axis(2, at = seq(-.4, .4, .1), lwd=3)
#dev.off()


# create a variable for condition code
# 1 = control, control
# 2 = control, strategy
# 3 = strategy, control
# 4 = strategy, strategy

#pdf("/Users/hayley/Desktop/shenhavLabTalk/rpgamByRoundAllcond.pdf")
par(pty="s")
plot(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode1)], RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode1)], asp=1,col="blue", pch=16, ylim=c(0,1), xlim=c(0,1), ylab="p(gamble round 1)", xlab="p(gamble round 2)", axes=F, cex=2)

abline(a = 0, b=1, lty="dashed", col="darkgrey",lwd=5)

points(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode2)], RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode2)], col="green",asp=1, pch=16,cex=2)

points(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode3)], RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode3)], asp=1, col="red", pch=16, cex=2)


points(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode4)], RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode4)], asp= 1,col="purple", pch=16, cex=2)
axis(1, lwd=6)
axis(2, lwd=6)
legend("bottomright", legend=c("nat-nat","nat-strat", "strat-nat" ,"strat-strat"), pch=16, bty="n", col=c("blue", "green", "red", "purple"), cex=1)

#dev.off()


#pdf("/Users/hayley/Desktop/shenhavLabTalk/rpgamDiff_cond2_cond3.pdf")
plot(c(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode2)]- RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode2)], RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode3)]- RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode3)]), pch=16, ylab="Risk-taking\n (round 1 - round 2)", xlab="participant", ylim=c(-.5,.5),cex= 2,col=c(rep("green",length(condcode2)), rep("red", length(condcode3))), axes=F)
axis(1, at = 1:13, labels = as.numeric(c(condcode2, condcode3)), lwd=6, cex.axis=1)
axis(2, lwd=6, cex=1.5)
abline(h=0, col="darkgrey", lty="dashed", lwd=4)

points(c(RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode2)]- RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode2)], RDMqualityCheck$pgambleRound1[RDMqualityCheck$subID %in% as.numeric(condcode3)]- RDMqualityCheck$pgambleRound2[RDMqualityCheck$subID %in% as.numeric(condcode3)]), pch=16, cex= 2,col=c(rep("green",length(condcode2)), rep("red", length(condcode3))))

legend("bottomright", legend=c("nat-strat", "strat-nat"), pch=16, bty="n", col=c("green","red"), cex=1)
#dev.off()



```


#### Post round difficulty ratings
```{r}
# summary stats for diffciculty ratings in each condition and order
# participant generally felt that strategy was more difficult, on average.
summary(rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$strategy==0])
summary(rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$strategy==1])

# for participants who did natural condition both rounds, difficulty ratings is on average, higher for second round
natNatRound1difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==1 & rdmPostRoundQsdf$...1==1]
natNatRound2difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==1 & rdmPostRoundQsdf$...1==2]

summary(natNatRound1difficulty)
summary(natNatRound2difficulty)


# for participants who did natural then strategy, difficulty rating is on average, higher for second round (strategy harder)
natStratRound1difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==2 & rdmPostRoundQsdf$...1==1]
natStratRound2difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==2 & rdmPostRoundQsdf$...1==2]

summary(natStratRound1difficulty)
summary(natStratRound2difficulty)

# for participants who did strategy then natural, difficulty rating is on average, higher for first round (strategy harder)
stratNatRound1difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==3 & rdmPostRoundQsdf$...1==1]
stratNatRound2difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==3 & rdmPostRoundQsdf$...1==2]

summary(stratNatRound1difficulty)
summary(stratNatRound2difficulty)

# for participants who did strategy then strategy, difficulty rating is on average, higher for first round 
stratStratRound1difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==4 & rdmPostRoundQsdf$...1==1]
stratStratRound2difficulty = rdmPostRoundQsdf$difficulty[rdmPostRoundQsdf$condCode==4 & rdmPostRoundQsdf$...1==2]

summary(stratStratRound1difficulty)
summary(stratStratRound2difficulty)

pdf(file.path(config$path$directory, config$path$shlab_figures,'InstDifficultyRatingPlots.pdf'))
par(pty="s", mfrow= c(2,2))
plot(natNatRound1difficulty, natNatRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Act natural Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="blue")
abline(a=0, b=1, col="grey")

plot(natStratRound1difficulty, natStratRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Act natural Round 1", pch=16, cex = 1.5, col="green")
abline(a=0, b=1, col="grey")

plot(stratNatRound1difficulty, stratNatRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Act Natural Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="red")
abline(a=0, b=1, col="grey")

plot(stratStratRound1difficulty, stratStratRound2difficulty, ylim=c(0,100), xlim=c(0,100), ylab="Strategy Round 2", xlab="Strategy Round 1", pch=16, cex = 1.5, col="purple")
abline(a=0, b=1, col="grey")

mtext("Instruction Difficulty Ratings", side = 3, line = - 2, outer = TRUE)
dev.off()
```


### Generalized linear mixed effects models
#### Trial-level
##### More risk-taking in strategy condition, but not keeping strategy in trial-level model because we want to use it in recent event models
```{r trial-level-glmer}

model1_trialLev= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode + (1|subID), data=rdmDFclean , family = "binomial")

summary(model1_trialLev)

# gain and safe as expected, no effect of ev level or round, AIC = 7407.0


model2_trialLev= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode*strategyRecode + (1|subID), data=rdmDFclean , family = "binomial")

summary(model2_trialLev)

# Gain and safe as expection. Including round and strategy shows no effect of round but strategy is associated with increased risk in the strategy (Relative to act natural condition), AIC = 7385.2
```

```{r save-predicted-values, echo=FALSE}
rdmDFclean$pred= predict(model1_trialLev,type="link"); 
par(mfrow=c(1,1))
#plot(mriBehClean$pred, ylab="predicted values");

```


### Recent event models
####shift effect is not showing up as we'd expect but seeing signs of local and global timescales
####Strategy is interacting with past outcome, earnings and expectations.
```{r basic-recent-events-model}

model3_poc = glmer(choice ~ 0 + pastOC1sc + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model3_poc)
# no outcome effect

model4_pocStrat = glmer(choice ~ 0 + pastOC1sc*strategyRecode + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model4_pocStrat)
# trending positive interaction, interesting that strategy is not significant but is in the models below with the other timescales


model5_signedShiftStrat = glmer(choice ~ 0 + signedShift*strategyRecode + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model5_signedShiftStrat)

model6_posNegShiftStrat = glmer(choice ~ 0 + posShift*strategyRecode + negShift*strategyRecode +(1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model6_posNegShiftStrat)
# effect of negative shift and strategy

model7_posShift = glmer(choice ~ 0 + posShift +(1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
# no effect of positive shift


model8_earnsExp = glmer(choice ~ 0 + earnNormalizedOverall + trialSC + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model8_earnsExp)
# trending, direction is the same as previous data sets though

model9_3timescales = glmer(choice ~ 0 + pastOC1sc*earnNormalizedOverall + posShift + trialSC + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)
summary(model9_3timescales)
# negative effect of past outcome, interaction between outcomes and earnings

model10_3timescalesStrategy = glmer(choice ~ 0 + pastOC1sc*earnNormalizedOverall*strategyRecode + posShift*strategyRecode + trialSC*strategyRecode + (1|subIDnum), data=rdmDFclean, family="binomial", offset=pred)

summary(model10_3timescalesStrategy)

# temporal effects at local and global consistent with previous datasets
# strategy mostly interaction with outcomes and earnings/expectations
```



