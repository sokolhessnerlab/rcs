---
title: "Models for Dissertation Document"
author: "Hayley Brooks"
date: "2023-03-12"
output:
  word_document: default
  html_document: default
  pdf_document: default
---
### This R markdown file includes all models of results reported in the main text and supplememntal analyses of 'Cognitive strategy use selectively changes temporal context effects in risky monetary decision-making' (Brooks & Sokol-Hessner, 2023)

```{r setup, include=FALSE}
rm(list=ls())

library('config')
config = config::get()

library('lmerTest')
library(dplyr)

setup_source = file.path(config$path$code_files$dataSetUp) # run our set up script (which loads all the data)
source(setup_source) #, local = knitr::knit_global())

```


Main text results:
1. Subjective experiences and cognitive processing was similar across strategies
  - Difficulty (model 1)
  - Frequency (model 2)
  - reaction time across conditions (model 3)
2. Participants treated two rounds of gambling task as independent
  - ratings of round independence (model 4)
3. Strategic effect on temporal context in risk depends on emotion regulation
  - trial-level model to account for trial-level variables and get predicted values (trial-level model)
  - strategy x temporal context and strategy x covariates (old model 6; now 5)
  - strategy x reap (continuous) x temporal context (old model 7; now 6)
  - strategy x reap (3 groups) x temporal context (old model 8; now 7; exploratory)

```{r subjective-experiences-cognitive-processing-across-conditions}
# Do difficulty ratings, frequency and reaction time vary across conditions?
rcsSubLevelLong_clean$strategyRecode = rcsSubLevelLong_clean$strategy
rcsSubLevelLong_clean$strategyRecode[rcsSubLevelLong_clean$strategyRecode==0]= -1
rcsSubLevelLong_clean$rdmRound = rep(c(-1,1), times = nSub)

mean(rcsSubLevelLong_clean$instDifficult[rcsSubLevelLong_clean$strategy==0])
mean(rcsSubLevelLong_clean$instDifficult[rcsSubLevelLong_clean$strategy==1])

diffRoundStrat = lmer(instDifficult~strategyRecode*rdmRound + (1|subID), data=rcsSubLevelLong_clean); # no effect of round or strategy, no interaction on difficulty ratings in linear mixed effects model
summary(diffRoundStrat)


mean(rcsSubLevelLong_clean$instHowOften[rcsSubLevelLong_clean$strategy==0])
mean(rcsSubLevelLong_clean$instHowOften[rcsSubLevelLong_clean$strategy==1])

freqRoundStrat = lmer(instHowOften~strategyRecode*rdmRound + (1|subID), data=rcsSubLevelLong_clean); # no effect of round or strategy, no interaction on difficulty ratings in linear mixed effects model
summary(freqRoundStrat); # no effect of strategy on frequency, potential effect of round (trending at p=.08), no interaction where frequency is lower in round 2 consistent with results above


RT_roundStrat_500ms= lmer(sqrt(RT) ~ roundRDM + strategyRecode + roundRDM*strategyRecode + (1|subID), data= rdmDFclean[rdmDFclean$RT>.5,]);
summary(RT_roundStrat_500ms); 

# round 1, nat: -.04*-1 + -.014*-1 +  .01*-1*-1 = .064 weight on RT
# round 1, strat: -.04*-1 + -.014*1 +  .01*-1*1 = .016 weight on RT
# round 2, nat: -.04*1 + -.014*-1 +  .01*-1*1 = -.036 weight on RT
# round 2, strat: -.04*1 + -.014*1 +  .01*1*1 = -.044 weight on RT

# calculate the implied mean RT based on above model:
# start with overall mean sqrt RT = 1.15s (median =1.11s)
# round 1, nat: 1.15 +.064 = 1.214s
# round 1, strat: 1.15 +.016  = 1.166s
# round 2, nat: 1.15 -.036 = 1.114s
# round 2, strat: 1.15 -.044 = 1.106s

```

```{r participants-treated-rounds-of-gambling-task-as-independent}
# Do participants perceive rounds of gambling task as independent?
rcsSubLevelWide_clean$rdmRoundsIndepNumeric = as.numeric(rcsSubLevelWide_clean$rdmRoundsIndep)
summary(rcsSubLevelWide_clean$rdmRoundsIndepNumeric); # mean= 4.99; median = 5; range = 1-7 (on a scale from 1-7)
sd(rcsSubLevelWide_clean$rdmRoundsIndepNumeric); # 1.553888

rcsSubLevelLong_clean$rdmRoundsIndepNumeric = as.numeric(rcsSubLevelLong_clean$rdmRoundsIndep)
rcsSubLevelLong_clean$rdmRoundsIndepScaled = rcsSubLevelLong_clean$rdmRoundsIndepNumeric/max(rcsSubLevelLong_clean$rdmRoundsIndepNumeric);

roundIndepRoundStrat = lmer(rdmRoundsIndepScaled~strategyRecode*rdmRound + (1|subID), data=rcsSubLevelLong_clean);
summary(roundIndepRoundStrat); # no effect of round, strategy or roundxstrategy on how independent the rounds felt.

```


```{r strategic-effect-on-context-depends-on-reappraisal, echo=TRUE}

# Account for current trial-level variables, strategy, and round:
trialLevelModel = glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode*strategyRecode + (1|subID), data=rdmDFclean , family = "binomial")
summary(trialLevelModel)

# Save predicted values for contextual models:
rdmDFclean$predTrialLevModel= predict(trialLevelModel,type="link"); 

# The effect of strategy is selective to the immediate timescale and depends on reappraisal
# 2 models: looking at covariates x strategy and then using those results to determine which covariate to follow up on
# Does the effect of strategy on risk co-vary with working memory capacity, ERQ and motivation?
model6 = glm(choice~0 + pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + suppSpan0mean*strategyRecode + reapSpan0mean*strategyRecode + motivationNumeric*strategyRecode + compositeSpanScore*strategyRecode, data=rdmDFclean, family="binomial",offset=predTrialLevModel);
summary(model6);

# Because reappraisal appears to be the only covariate that may be related to strategy-use, our next question is does the effect of strategy on temporal context in risk co-vary with ERQ reappraisal?
model7 = glm(choice~0 + pastOC1sc*strategyRecode*reapSpan0mean + signedShiftsc*strategyRecode*reapSpan0mean + earnNormalizedOverall*strategyRecode*reapSpan0mean + linExpectation*strategyRecode*reapSpan0mean, data=rdmDFclean, family="binomial",offset=predTrialLevModel);
summary(model7);


# Exploratory analysis: splitting up reappraisal into tertiles to understand potential nonlinearities between low, medium and high reappraisal groups.
model8 = pocShiftEarnExp_ERQreapXstratXpoc_highLowReap3rdsplit = glm(choice~0 + pastOC1sc*strategyRecode*highReapTopThird +pastOC1sc*strategyRecode*lowReapBottomThird + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode, data=rdmDFclean, family="binomial",offset=predTrialLevModel);
summary(model8);





```



Supplemental analysis results:
Risk-taking Across Strategies and Rounds
- this is the trial-level model above and we use the results from this model to generate SI figure2


Temporal Context Effects replicate
```{r temporal-context-effects-replicate}

# Does risk-taking change as a function of past outcome, shift, earnings and expectations? MOVE TO SI ANALYSIS
model2 = glm(choice ~ 0 + pastOC1sc + signedShiftsc + earnNormalizedOverall + linExpectation, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model2);

```

```{r additional-shift-analyses}
# In this dataset, we find that signed shift is better behaved than splitting up positive and negative shift:

model2_b_posNegShift = glm(choice ~ 0 + pastOC1sc + posShiftsc + negShiftsc + earnNormalizedOverall + linExpectation, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model2_b_posNegShift); 
# AIC is better (lower) with signed shift.

# In previous datasets, we find that shift effect is short lasting (shift immediately before a trial). Is that the case here? 
model2_c_howFarBack = glm(choice ~ 0 + pastOC1sc + signedShiftsc + + earnNormalizedOverall + linExpectation + signedShift_1triback, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model2_c_howFarBack); 
# Yes, adding shift 1 trial back is not significant.

```

Temporal Context Effects and Strategy 
```{r}
# Does strategy interact with temporal context? NMOVE TO SI ANALYSIS
model4= glm(formula = choice ~ 0 + pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode, family = "binomial", data = rdmDFclean, offset = predTrialLevModel)
summary(model4);

# Does the effect of strategy on context vary with round? MOVE TO SI ANALYSIS
model5 = glm(formula = choice ~ 0 + pastOC1sc*strategyRecode*roundRecode + signedShiftsc*strategyRecode*roundRecode + earnNormalizedOverall*strategyRecode*roundRecode + linExpectation*strategyRecode*roundRecode, family = "binomial", data = rdmDFclean, offset = predTrialLevModel)
summary(model5)
```


Reaction time variability 



Earnings and expectations between and across rounds and for people who switch-vs-repeat conditions
```{r earnings-expectations-across-rounds}
# Do people track earnings and expectations across rounds? MOVE TO SI ANALYSIS
model3 =glm(choice ~ 0 + pastOC1sc + signedShiftsc + earnNormalizedOverall+ linExpectation+ earningsAcrossRounds + linExpAcrossRounds, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model3);

# Do people track earnings and expectations across rounds? (additional analyses)
# Just include earnings and expectations across rounds (remove earnings and expectations within round)
model3_b =glm(choice ~ 0 + pastOC1sc + signedShiftsc + earningsAcrossRounds + linExpAcrossRounds, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model3_b);
# AIC is worse when accounting for earnings and expectations across rounds relative to earnings/expectations within rounds but the effects are significant.

# Because the effects of earnings and expectations across rounds is significant when in a model alone, perhaps some people track earnings across tasks. Who are the people tracking earnings and expectations across rounds? People who repeat the same condition across rounds may treat earnings and expectations continuous across rounds whereas people who switched conditions may have treated the rounds more independently.

```

```{r earnings-expectations-switch-vs-repeat-conditions}
# Do people who switch conditions vs. repeat conditions treat earnings and expectations differently across rounds?

# defining condition codes:
condcode1 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==1]
condcode2 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==2]
condcode3 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==3]
condcode4 = rcsSubLevelWide_clean$subID[rcsSubLevelWide_clean$condCode==4]


# Subset data for those who repeated conditions (condition codes 1 and 4)
repeatconditions = c(condcode1, condcode4)
rdmDFrepeatCond = rdmDFclean[as.numeric(rdmDFclean$subID) %in% repeatconditions,]

# Subset data for those who switched conditions (condition codes 2 and 3)
switchconditions = c(condcode2, condcode3)
rdmDFswitchCond = rdmDFclean[as.numeric(rdmDFclean$subID) %in% switchconditions,]


# Run trial-level models that include round x strategy as we did in model 1 in main analysis:
model1_repeatConditions= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode*strategyRecode + (1|subID), data=rdmDFrepeatCond , family = "binomial")
summary(model1_repeatConditions);

model1_swithConditions= glmer(choice ~ 1 + gainScaled + safeScaled + evLevScaled + roundRecode*strategyRecode + (1|subID), data=rdmDFswitchCond , family = "binomial")
summary(model1_swithConditions);

# Trial-level model summaries for switch vs repeat conditions -> strategy increases risk-taking for everyone, but this effect is stronger over time for people who repeat condition. More time with specific strategy = stronger effect of that strategy.


# Save predicted values to the switch and repeat datasets
rdmDFrepeatCond$pred= predict(model1_repeatConditions,type="link"); 
rdmDFswitchCond$pred= predict(model1_swithConditions,type="link"); 

# Do we see the same temporal context effects as above in the whole dataset
# For repeat conditions:
model2_repeatConditions = glm(choice ~ 0 + pastOC1sc + signedShiftsc + linExpectation + earnNormalizedOverall, data=rdmDFrepeatCond, family="binomial", offset=pred);
summary(model2_repeatConditions);
# main effects as above except no effect of signed shift (p = .13) in people who repeat condition

# switch:
model2_switchConditions = glm(choice ~ 0 + pastOC1sc + signedShiftsc + linExpectation + earnNormalizedOverall, data=rdmDFswitchCond, family="binomial", offset=pred);
summary(model2_switchConditions);
# main effects same as above - including effect of signed shift for people who switch conditions



# Could people who switch vs. repeat be treating expectations and earnings differently  (i.e. tracking earnings across rounds)?

# Repeat:
model3_repeatcond_acrossRounds = glm(choice ~ 0 + pastOC1sc + signedShiftsc + linExpAcrossRounds + earningsAcrossRounds, data=rdmDFrepeatCond, family="binomial", offset=pred);
summary(model3_repeatcond_acrossRounds);
#AIC is an improvement from model above with expectations and earnings within round (AIC: 15039) 

# Switch
model_switchcond_acrossRounds = glm(choice ~ 0 + pastOC1sc + signedShiftsc + linExpAcrossRounds + earningsAcrossRounds, data=rdmDFswitchCond, family="binomial", offset=pred);
summary(model_switchcond_acrossRounds);
# AIC much worse than model with linear expectations and earnings within round (AIC: 15160)

# Summary -> people who repeat conditions seem to track expectations and earnings across rounds (direction of effects are consistent across groups though) but people who switch appear to treat expectations and earnings separately across rounds.


```

Additional covariate analyses

```{r individual-covariate-models}

# MOTIVATION
# Does motivation interact with strategy to influence risk-taking?
model6_b_motivationOnly = glm(choice~0+pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + strategyRecode*motivationNumeric, data=rdmDFclean, family="binomial", offset=predTrialLevModel);
summary(model6_b_motivationOnly);

# ERQ REAPPRAISAL
model6_b_reappraisalOnly = glm(choice~0+pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + strategyRecode*reapSpan0mean, data=rdmDFclean, family="binomial", offset=predTrialLevModel);
summary(model6_b_reappraisalOnly);


# ERQ SUPPRESSION
# Does habitual use of expressive suppression interact with strategy to influence risk-taking?
model6_c_suppressionOnly = glm(choice~0+pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + strategyRecode*suppSpan0mean, data=rdmDFclean, family="binomial", offset=predTrialLevModel);
summary(model6_c_suppressionOnly);


# COMPOSITE SPAN (WORKING MEMORY CAPACITY)
# Does working memory capacity interact with strategy to influence risk-taking?
model6_d_compositeSpanOnly = glm(choice~0+pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + strategyRecode*compositeSpanScore, data=rdmDFclean, family="binomial", offset=predTrialLevModel);
summary(model6_d_compositeSpanOnly);



# Summary -> across these covariates (suppression, motivation and span), there is no main effect of them or an interaction with strategy. Because ERQ reappraisal was the strongest effect from the beginning (in a model that accounted for all covariates), this appears to be the strongest effect and the other covariates may require follow up in future work.

model6b_motivxwmc = glm(choice~0 + pastOC1sc*strategyRecode + signedShiftsc*strategyRecode + earnNormalizedOverall*strategyRecode + linExpectation*strategyRecode + suppSpan0mean*strategyRecode + reapSpan0mean*strategyRecode + motivationNumeric*compositeSpanScore*strategyRecode, data=rdmDFclean, family="binomial",offset=predTrialLevModel);
summary(model6b_motivxwmc);

```


Immediate x Global timescale model
```{r immediate-global-interaction}
# In previous datasets, we have found an interaction between past outcome and earnings. Do we see that here?

# Interact past outcome with both global timescale variables:
model2_POCxEarn_POCxExp = glm(choice ~ 0 + pastOC1sc + signedShiftsc + earnNormalizedOverall*pastOC1sc + linExpectation*pastOC1sc, data=rdmDFclean, family="binomial", offset=predTrialLevModel)
summary(model2_POCxEarn_POCxExp); 

# There is an interaction between past outcome and earnings, as well as past outcome and expectations. This means that the negative effect of past outcome is stronger when earnings increase and flips as expectations increase. The joint effect of earnings and expectations on the past outcome effect is that when earnings are more than expected, the effect of past outcome is positive and is negative when earnings are less than expected. The effect is weakest when earnings and expectations are very low (i.e. at the beginning of the task) and is strongest when earnings and expectations are large (toward the end of the task).

# See Supplemental Materials for discussion of these results.
```

