---
title: "rcs_basicStanAssess"
author: "Hayley Brooks"
date: "2023-02-03"
output: html_document
---

Load and assess model fit for stan models for HRB's dissertation (RCS)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(config)
library(rstan)
config = config::get()


#load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_basicRhoMu_20230125.Rdata'));
#load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_basicRhoMu_20230203.Rdata'));
#load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_rhoMuDB_20230208.Rdata'))
#load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_rhoMuDB_pocadj_20230217.Rdata'))
#load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_roundStrategy_rhoMuDB_changeDB_20230219.Rdata'))
load(file.path(config$path$data$Rdata, 'stanModelOutput/rcs_roundStrategy_rhoMuDB_changeDB_20230220.Rdata'))
```


```{r}

fit1 <- sflist2stanfit(sflistFinal)

sSamples <- extract(fit1)


 
print(fit1)

fit1summ = summary(fit1);

neffs = fit1summ$summary[,'n_eff'];
rhats = fit1summ$summary[,'Rhat'];


#meanparams = c('meanRho','meanMu', 'meanDB', 'meanPocAdjDB','meanPocAdjM','meanPocAdjR')
meanparams = c('meanRho','meanMu', 'meanDB', 'roundDB','stratDB','roundxstratDB')

sdparams = c('sdRho','sdMu', 'sdDB') #, 'sdPocAdjDB','sdPocAdjM','sdPocAdjR')

neffs[meanparams]
rhats[meanparams]

neffs[sdparams]
rhats[sdparams]




# 2/3/23: basic model results look reasonable and the rhats are ~1 which is good, will run this model again with many more samples. 
# 2/6/23: basic model with several more samples (10,000, so really 5,000) similarly looks good! Will complicate wtih decision bias
# 2/8/23: model with rho, mu and decision bias looks good (rhats ~1), fewer effective samples for decision bias but the parameter estimates look reasonable
# 2/17/23: model with rho, mu and db + poc adjustment (RFX for all) - takes about 17 hours with 4 chains and 10k samples. The traceplots look fuzzy. Rhats are all around 1 with the higest being 1.07 for rho adjust and 1.03 for mean rho but number of effective samples is very small (45 for mean rho and 16 for mean poc adj r).

```

```{r}

model_fit_obj = sflist2stanfit(sflistFinal);
print(model_fit_obj)

sampled_values = extract(model_fit_obj);
q95 = c(0.025, 0.975);

traceplot(model_fit_obj,'meanRho')
traceplot(model_fit_obj,'meanMu')
traceplot(model_fit_obj,'meanDB')

#traceplot(model_fit_obj,'meanPocAdjR')
#traceplot(model_fit_obj,'meanPocAdjM')
#traceplot(model_fit_obj,'meanPocAdjDB')

mean(exp(sampled_values$meanRho))
quantile(exp(sampled_values$meanRho), probs = q95)
mean(exp(sampled_values$meanMu))
quantile(exp(sampled_values$meanMu), probs = q95)
mean(exp(sampled_values$meanDB))
quantile(exp(sampled_values$meanDB), probs = q95)

mean(exp(sampled_values$roundDB))
quantile(exp(sampled_values$roundDB), probs = q95)
mean(exp(sampled_values$stratDB))
quantile(exp(sampled_values$stratDB), probs = q95)
mean(exp(sampled_values$roundxstratDB))
quantile(exp(sampled_values$roundxstratDB), probs = q95)


# mean(exp(sampled_values$meanPocAdjR))
# quantile(exp(sampled_values$meanPocAdjR), probs = q95)
# mean(exp(sampled_values$meanPocAdjM))
# quantile(exp(sampled_values$meanPocAdjM), probs = q95)
# mean(exp(sampled_values$meanPocAdjDB))
# quantile(exp(sampled_values$meanPocAdjDB), probs = q95)

hist(exp(sampled_values$meanRho), xlim = c(0.5,1))
hist(exp(sampled_values$meanMu), xlim = c(0,30))
hist(exp(sampled_values$meanDB), xlim = c(0, 1))

# fitsumm = summary(model_fit_obj)

# neffs = fit1summ$summary[,'n_eff'];
# rhats = fit1summ$summary[,'Rhat'];
# 
#  meanparams = c('meanRho','meanMu', 'meanDB', 'meanPocAdjDB','meanPocAdjM','meanPocAdjR')
# 
# sdparams = c('sdRho','sdMu', 'sdDB', 'sdPocAdjDB','sdPocAdjM','sdPocAdjR')
# 
# neffs[meanparams]
# rhats[meanparams]
# 
# neffs[sdparams]
# rhats[sdparams]


```

